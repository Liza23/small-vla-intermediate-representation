"""
Visualize VLA Model Architecture
"""

import torch
from models import VLAModel
import yaml

def print_architecture():
    """Print detailed architecture diagram"""

    # Load config
    with open('configs/single_task_overfit.yaml', 'r') as f:
        config = yaml.safe_load(f)

    print("\n" + "="*80)
    print(" VLA MODEL ARCHITECTURE WITH RECTIFIED FLOW")
    print("="*80)

    print("\nğŸ“¥ INPUT MODALITIES:")
    print("â”€" * 80)
    print("â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”")
    print("â”‚ 1. RGB Image (224Ã—224Ã—3)                                                   â”‚")
    print("â”‚    â””â”€> Normalized with CLIP stats                                          â”‚")
    print("â”‚                                                                             â”‚")
    print("â”‚ 2. Language Instruction (text string)                                      â”‚")
    print("â”‚    â””â”€> Tokenized to 77 tokens max                                          â”‚")
    print("â”‚                                                                             â”‚")
    print("â”‚ 3. Robot Proprioception (7D)                                               â”‚")
    print("â”‚    â””â”€> Joint positions [q1, q2, ..., q7]                                   â”‚")
    print("â”‚                                                                             â”‚")
    print("â”‚ 4. End-Effector Pose (7D)                                                  â”‚")
    print("â”‚    â””â”€> [x, y, z, ori_x, ori_y, ori_z, gripper]                            â”‚")
    print("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜")

    print("\nğŸ§  ENCODER NETWORKS:")
    print("â”€" * 80)

    print("\nâ”Œâ”€â”€â”€ Vision Encoder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”")
    print("â”‚  CLIP ViT-B/16 (Frozen â„ï¸)                                                 â”‚")
    print("â”‚  â€¢ Input: [B, 3, 224, 224]                                                  â”‚")
    print("â”‚  â€¢ Architecture: 12 transformer layers, 12 attention heads                  â”‚")
    print("â”‚  â€¢ Patch size: 16Ã—16 â†’ 196 patches                                          â”‚")
    print("â”‚  â€¢ Hidden dim: 768                                                           â”‚")
    print("â”‚  â€¢ Output: Pooled features [B, 768]                                         â”‚")
    print("â”‚  â€¢ Projection: Linear(768 â†’ 512) [B, 512]                                   â”‚")
    print("â”‚  â€¢ Parameters: ~85M (frozen)                                                 â”‚")
    print("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜")

    print("\nâ”Œâ”€â”€â”€ Language Encoder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”")
    print("â”‚  CLIP Text Encoder (Frozen â„ï¸)                                             â”‚")
    print("â”‚  â€¢ Input: [B, 77] token IDs                                                 â”‚")
    print("â”‚  â€¢ Architecture: 12 transformer layers                                      â”‚")
    print("â”‚  â€¢ Vocab size: 49,408                                                        â”‚")
    print("â”‚  â€¢ Hidden dim: 512                                                           â”‚")
    print("â”‚  â€¢ Output: Pooled features [B, 512]                                         â”‚")
    print("â”‚  â€¢ Projection: Linear(512 â†’ 512) [B, 512]                                   â”‚")
    print("â”‚  â€¢ Parameters: ~60M (frozen)                                                 â”‚")
    print("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜")

    print("\nâ”Œâ”€â”€â”€ Proprioception Encoder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”")
    print("â”‚  MLP (Trainable ğŸ”¥)                                                         â”‚")
    print("â”‚  â€¢ Input: [B, 7] joint positions                                            â”‚")
    print("â”‚  â€¢ Architecture:                                                             â”‚")
    print("â”‚      Linear(7 â†’ 128)                                                         â”‚")
    print("â”‚      LayerNorm(128)                                                          â”‚")
    print("â”‚      ReLU()                                                                  â”‚")
    print("â”‚      Linear(128 â†’ 512)                                                       â”‚")
    print("â”‚  â€¢ Output: [B, 512]                                                          â”‚")
    print("â”‚  â€¢ Parameters: ~66K (trainable)                                              â”‚")
    print("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜")

    print("\nâ”Œâ”€â”€â”€ End-Effector Encoder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”")
    print("â”‚  MLP (Trainable ğŸ”¥)                                                         â”‚")
    print("â”‚  â€¢ Input: [B, 7] end-effector pose                                          â”‚")
    print("â”‚  â€¢ Architecture: (same as proprio encoder)                                   â”‚")
    print("â”‚      Linear(7 â†’ 128)                                                         â”‚")
    print("â”‚      LayerNorm(128)                                                          â”‚")
    print("â”‚      ReLU()                                                                  â”‚")
    print("â”‚      Linear(128 â†’ 512)                                                       â”‚")
    print("â”‚  â€¢ Output: [B, 512]                                                          â”‚")
    print("â”‚  â€¢ Parameters: ~66K (trainable)                                              â”‚")
    print("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜")

    print("\nğŸ”€ FUSION LAYER:")
    print("â”€" * 80)
    print("â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”")
    print("â”‚  Multi-Modal Fusion MLP (Trainable ğŸ”¥)                                     â”‚")
    print("â”‚  â€¢ Input: Concatenate all embeddings [B, 512Ã—4 = 2048]                     â”‚")
    print("â”‚  â€¢ Architecture:                                                             â”‚")
    print("â”‚      Linear(2048 â†’ 1024)                                                     â”‚")
    print("â”‚      LayerNorm(1024)                                                         â”‚")
    print("â”‚      ReLU()                                                                  â”‚")
    print("â”‚      Linear(1024 â†’ 512)                                                      â”‚")
    print("â”‚      LayerNorm(512)                                                          â”‚")
    print("â”‚  â€¢ Output: Fused condition vector [B, 512]                                  â”‚")
    print("â”‚  â€¢ Parameters: ~2.6M (trainable)                                             â”‚")
    print("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜")

    print("\nğŸŒŠ RECTIFIED FLOW MODULE:")
    print("â”€" * 80)
    print("â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”")
    print("â”‚  Flow Network: v(x_t, t, condition) â†’ velocity field                       â”‚")
    print("â”‚                                                                              â”‚")
    print("â”‚  â€¢ Time Embedding:                                                           â”‚")
    print("â”‚      Linear(1 â†’ 512)                                                         â”‚")
    print("â”‚      SiLU()                                                                  â”‚")
    print("â”‚      Linear(512 â†’ 512)                                                       â”‚")
    print("â”‚                                                                              â”‚")
    print("â”‚  â€¢ Flow Network Input: [x_t (7D), condition (512D), time_emb (512D)]       â”‚")
    print("â”‚      Total input dim: 7 + 512 + 512 = 1031                                  â”‚")
    print("â”‚                                                                              â”‚")
    print("â”‚  â€¢ Flow Network Architecture (4 layers):                                     â”‚")
    print("â”‚      Layer 1: Linear(1031 â†’ 512) + LayerNorm + SiLU                        â”‚")
    print("â”‚      Layer 2: Linear(512 â†’ 512) + LayerNorm + SiLU                         â”‚")
    print("â”‚      Layer 3: Linear(512 â†’ 512) + LayerNorm + SiLU                         â”‚")
    print("â”‚      Layer 4: Linear(512 â†’ 512) + LayerNorm + SiLU                         â”‚")
    print("â”‚      Output:  Linear(512 â†’ 7) [velocity prediction]                         â”‚")
    print("â”‚                                                                              â”‚")
    print("â”‚  â€¢ Parameters: ~2.2M (trainable)                                             â”‚")
    print("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜")

    print("\nâš™ï¸ TRAINING PROCESS:")
    print("â”€" * 80)
    print("â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”")
    print("â”‚  Rectified Flow Loss:                                                       â”‚")
    print("â”‚                                                                              â”‚")
    print("â”‚  1. Sample time: t ~ Uniform(0, 1)                                          â”‚")
    print("â”‚  2. Sample noise: x_0 ~ N(0, I)                                             â”‚")
    print("â”‚  3. Interpolate: x_t = tÂ·x_1 + (1-t)Â·x_0   (straight path)                 â”‚")
    print("â”‚  4. Target velocity: v_target = x_1 - x_0                                   â”‚")
    print("â”‚  5. Predict velocity: v_pred = flow_net(x_t, t, condition)                 â”‚")
    print("â”‚  6. Loss: MSE(v_pred, v_target)                                             â”‚")
    print("â”‚                                                                              â”‚")
    print("â”‚  Optimization: AdamW(lr=3e-4, weight_decay=1e-4)                            â”‚")
    print("â”‚  Scheduler: CosineAnnealing(T_max=1000, min_lr=1e-6)                        â”‚")
    print("â”‚  Gradient Clipping: max_norm=1.0                                            â”‚")
    print("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜")

    print("\nğŸ¯ INFERENCE PROCESS:")
    print("â”€" * 80)
    print("â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”")
    print("â”‚  Euler Integration (50 steps):                                              â”‚")
    print("â”‚                                                                              â”‚")
    print("â”‚  1. Start: x_0 ~ N(0, I)  [random noise]                                    â”‚")
    print("â”‚  2. dt = 1/50 = 0.02                                                         â”‚")
    print("â”‚  3. For t = 0, dt, 2dt, ..., 1:                                             â”‚")
    print("â”‚       v = flow_net(x_t, t, condition)                                       â”‚")
    print("â”‚       x_{t+dt} = x_t + vÂ·dt                                                 â”‚")
    print("â”‚  4. Return: x_1  [predicted action]                                         â”‚")
    print("â”‚                                                                              â”‚")
    print("â”‚  Inference time: ~50ms (50 flow steps)                                      â”‚")
    print("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜")

    print("\nğŸ“¤ OUTPUT:")
    print("â”€" * 80)
    print("â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”")
    print("â”‚  Action Vector (7D):                                                         â”‚")
    print("â”‚  [dx, dy, dz, droll, dpitch, dyaw, gripper]                                 â”‚")
    print("â”‚  â€¢ Continuous values in action space                                         â”‚")
    print("â”‚  â€¢ Delta transformations (not absolute poses)                                â”‚")
    print("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜")

    print("\nğŸ“Š MODEL STATISTICS:")
    print("â”€" * 80)

    # Create model to get actual parameter counts
    model = VLAModel(**config['model'])

    total_params = sum(p.numel() for p in model.parameters())
    trainable_params = sum(p.numel() for p in model.parameters() if p.requires_grad)
    frozen_params = total_params - trainable_params

    print(f"â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”")
    print(f"â”‚  Total Parameters:     {total_params:>12,}  ({total_params/1e6:.1f}M)                       â”‚")
    print(f"â”‚  Trainable Parameters: {trainable_params:>12,}  ({trainable_params/1e6:.1f}M) ğŸ”¥                     â”‚")
    print(f"â”‚  Frozen Parameters:    {frozen_params:>12,}  ({frozen_params/1e6:.1f}M) â„ï¸                    â”‚")
    print(f"â”‚                                                                              â”‚")
    print(f"â”‚  Memory (training):    ~20 GB per GPU (batch_size=64)                       â”‚")
    print(f"â”‚  Memory (inference):   ~2 GB                                                 â”‚")
    print(f"â”‚                                                                              â”‚")
    print(f"â”‚  Trainable Breakdown:                                                        â”‚")
    print(f"â”‚    â€¢ Proprio Encoder:  ~66K                                                  â”‚")
    print(f"â”‚    â€¢ EE Encoder:       ~66K                                                  â”‚")
    print(f"â”‚    â€¢ Fusion Layer:     ~2.6M                                                 â”‚")
    print(f"â”‚    â€¢ Rectified Flow:   ~2.2M                                                 â”‚")
    print(f"â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜")

    print("\n" + "="*80)
    print(" END OF ARCHITECTURE")
    print("="*80 + "\n")


def save_flow_diagram():
    """Save a diagram showing the data flow"""

    diagram = """
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                         VLA MODEL DATA FLOW                                â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚   INPUTS     â”‚
                              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚                         â”‚                         â”‚
           â–¼                         â–¼                         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   RGB    â”‚            â”‚  Language    â”‚          â”‚ Proprio +   â”‚
    â”‚  Image   â”‚            â”‚ Instruction  â”‚          â”‚  EE Pose    â”‚
    â”‚ 224Ã—224  â”‚            â”‚   (text)     â”‚          â”‚   (14D)     â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
         â”‚                         â”‚                         â”‚
         â”‚ CLIP ViT-B/16          â”‚ CLIP Text               â”‚ MLPs
         â”‚ (frozen â„ï¸)             â”‚ (frozen â„ï¸)             â”‚ (train ğŸ”¥)
         â”‚                         â”‚                         â”‚
         â–¼                         â–¼                         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ [512]  â”‚              â”‚ [512]  â”‚               â”‚ [512+512]  â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                         â”‚
         â”‚                       â”‚                         â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚  CONCATENATE  â”‚
                         â”‚    [2048]     â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚ FUSION MLP    â”‚
                         â”‚ (train ğŸ”¥)    â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚  CONDITION    â”‚
                         â”‚    [512]      â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                                 â”‚
                â”‚      RECTIFIED FLOW             â”‚
                â”‚                                 â”‚
                â”‚   Training:                     â”‚
                â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
                â”‚   â”‚ x_t = tÂ·x_1 +   â”‚          â”‚
                â”‚   â”‚    (1-t)Â·x_0    â”‚          â”‚
                â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
                â”‚            â”‚                    â”‚
                â”‚            â–¼                    â”‚
                â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
                â”‚   â”‚  Flow Network   â”‚          â”‚
                â”‚   â”‚  v(x_t,t,cond)  â”‚          â”‚
                â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
                â”‚            â”‚                    â”‚
                â”‚            â–¼                    â”‚
                â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
                â”‚   â”‚ Loss: MSE(v,    â”‚          â”‚
                â”‚   â”‚    x_1 - x_0)   â”‚          â”‚
                â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
                â”‚                                 â”‚
                â”‚   Inference:                    â”‚
                â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
                â”‚   â”‚ x_0 ~ N(0,I)    â”‚          â”‚
                â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
                â”‚            â”‚ Euler (50 steps)  â”‚
                â”‚            â–¼                    â”‚
                â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
                â”‚   â”‚ x_t = x_t +     â”‚          â”‚
                â”‚   â”‚     vÂ·dt         â”‚          â”‚
                â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
                â”‚            â”‚                    â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚   ACTION      â”‚
                     â”‚    [7D]       â”‚
                     â”‚ dx,dy,dz,...  â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
"""

    with open('architecture_flow.txt', 'w') as f:
        f.write(diagram)

    print("Data flow diagram saved to: architecture_flow.txt")
    return diagram


if __name__ == '__main__':
    print_architecture()
    print("\n")
    flow = save_flow_diagram()
    print(flow)
